<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Court File App – Final Stable</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{font-family:system-ui;background:#f2f4f7;margin:0;padding:8px}
.section{background:#fff;padding:14px;margin-bottom:12px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
h3{margin:0 0 8px 0;font-size:15px}
input,button,select{width:100%;padding:12px;margin-top:8px;font-size:15px;border-radius:10px}
input,select{border:1px solid #ccc}
button{border:none;background:#1976d2;color:#fff;font-weight:600}
.scan-actions{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.table-wrap{background:#fff;border-radius:12px;overflow-x:auto}
table{width:100%;border-collapse:collapse;min-width:900px;font-size:13px}
th,td{border:1px solid #ddd;padding:6px;text-align:left}
th{background:#e9ecf1}
#scannerWrap{position:fixed;inset:0;background:#000;display:none;z-index:999}
#video{width:100%;height:75vh;object-fit:cover}
#scanBox{position:absolute;top:25%;left:15%;width:70%;height:50%;border:4px solid #00ff00;border-radius:10px}
#nextDatePopup{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:1000}
#popupBox{background:#fff;margin:25% auto;padding:20px;width:90%;border-radius:12px}
</style>
</head>
<body>

<div class="section">
<h3>Working Date</h3>
<input type="date" id="workDate">
<select id="versionSelect"></select>
</div>

<div class="section">
<h3>Excel Upload</h3>
<input type="file" id="excelFile">
<button onclick="uploadExcel()">Upload Excel</button>
</div>

<div class="section">
<h3>Search</h3>
<input type="text" id="searchBox">
</div>

<div class="section">
<h3>Scan</h3>
<div class="scan-actions">
<button onclick="scanSent()">Scan SENT</button>
<button onclick="scanReceived()">Scan RECEIVED</button>
</div>
</div>

<div class="section">
<button onclick="downloadExcel()">Download Excel</button>
</div>

<div class="table-wrap">
<table id="table"></table>
</div>

<div id="scannerWrap">
<div style="position:relative;">
<video id="video"></video>
<div id="scanBox"></div>
</div>
<button onclick="stopScanner()">Close</button>
</div>

<div id="nextDatePopup">
<div id="popupBox">
<h3>Select Next Date</h3>
<input type="date" id="nextDateInput">
<button onclick="saveNextDate()">Save</button>
</div>
</div>

<script>
let db;
let currentData=[];
let currentUploadId=null;
let scanMode="";
let lastReceivedIndex=null;
let currentSearch="";
let scannerInstance=null;

/* INIT DATABASE */
let request=indexedDB.open("CourtDB",1);
request.onupgradeneeded=e=>{
let d=e.target.result;
if(!d.objectStoreNames.contains("uploads")){
d.createObjectStore("uploads",{keyPath:"id",autoIncrement:true});
}
};
request.onsuccess=e=>{db=e.target.result;};

/* LOAD VERSIONS */
workDate.addEventListener("change",loadVersions);

function loadVersions(){
let tx=db.transaction("uploads","readonly");
let store=tx.objectStore("uploads");
store.getAll().onsuccess=e=>{
let data=e.target.result.filter(r=>r.date===workDate.value);
versionSelect.innerHTML="";
data.forEach(r=>{
let opt=document.createElement("option");
opt.value=r.id;
opt.textContent="Upload "+r.version;
versionSelect.appendChild(opt);
});
if(data.length){
let latest=data[data.length-1];
currentUploadId=latest.id;
versionSelect.value=latest.id;
currentData=latest.data;
applySearch();
}
};
}

versionSelect.addEventListener("change",()=>{
currentUploadId=parseInt(versionSelect.value);
let tx=db.transaction("uploads","readonly");
tx.objectStore("uploads").get(currentUploadId).onsuccess=e=>{
currentData=e.target.result.data;
applySearch();
};
});

/* UPLOAD */
function uploadExcel(){
if(!workDate.value){alert("Select date");return;}
let file=excelFile.files[0];
if(!file){alert("Select Excel");return;}

let reader=new FileReader();
reader.onload=e=>{
let wb=XLSX.read(e.target.result,{type:"binary"});
let rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1,defval:""});
rows.shift();

let newData=rows.map(r=>({
srno:r[0]||"",
caseno:String(r[1]||"").trim(),
partyname:r[2]||"",
section:r[3]||"",
ps:r[4]||"",
sent:"",
received:"",
receiveddate:"",
nextdate:"",
remark:""
}));

let tx=db.transaction("uploads","readwrite");
let store=tx.objectStore("uploads");

store.getAll().onsuccess=ev=>{
let sameDate=ev.target.result.filter(r=>r.date===workDate.value);
let version=sameDate.length+1;

store.add({
date:workDate.value,
version:version,
data:newData
}).onsuccess=ev2=>{
currentUploadId=ev2.target.result;
currentData=newData;
loadVersions();
alert("Saved as Upload "+version);
};
};
};
reader.readAsBinaryString(file);
}

/* SAVE */
function saveToDB(){
let tx=db.transaction("uploads","readwrite");
let store=tx.objectStore("uploads");
store.get(currentUploadId).onsuccess=e=>{
let record=e.target.result;
record.data=currentData;
store.put(record);
};
}

/* SEARCH */
searchBox.addEventListener("input",()=>{
currentSearch=searchBox.value.toLowerCase();
applySearch();
});

function applySearch(){
let filtered=currentSearch
? currentData.filter(r=>Object.values(r).join(" ").toLowerCase().includes(currentSearch))
: currentData;
drawTable(filtered);
}

/* SCANNER */
function scanSent(){scanMode="SENT";startScanner();}
function scanReceived(){scanMode="RECEIVED";startScanner();}

async function startScanner(){
if(!currentData.length){alert("No data");return;}
scannerWrap.style.display="block";
scannerInstance=new ZXing.BrowserQRCodeReader();
const devices=await scannerInstance.listVideoInputDevices();
const cam=devices.find(d=>d.label.toLowerCase().includes("back"))||devices[0];
scannerInstance.decodeFromVideoDevice(cam.deviceId,"video",(result)=>{
if(result){
let code=result.text.trim();
scannerInstance.reset();
stopScanner();
handleScan(code);
}
});
}

function stopScanner(){
scannerWrap.style.display="none";
}

/* HANDLE SCAN */
function handleScan(code){

let idx=currentData.findIndex(r=>r.caseno===code);

if(idx===-1){
alert("File Not Found ❌");
return;
}

if(scanMode==="SENT"){

if(currentData[idx].sent==="YES"){
alert("Already Sent ❌");
return;
}

currentData[idx].sent="YES";
saveToDB();
applySearch();
alert("Sent ✅");
return;
}

if(scanMode==="RECEIVED"){

if(currentData[idx].sent!=="YES"){
alert("File Not Sent Yet ❌");
return;
}

if(currentData[idx].received==="YES"){
alert("Already Received ❌");
return;
}

currentData[idx].received="YES";
currentData[idx].receiveddate=new Date().toLocaleDateString();
lastReceivedIndex=idx;

saveToDB();
applySearch();
alert("Received ✅");
nextDatePopup.style.display="block";
}
}

function saveNextDate(){
currentData[lastReceivedIndex].nextdate=nextDateInput.value;
nextDatePopup.style.display="none";
saveToDB();
applySearch();
}

function updateRemark(i,val){
currentData[i].remark=val;
saveToDB();
}

/* TABLE */
function drawTable(data){
table.innerHTML="";
if(!data.length)return;
let h=Object.keys(data[0]);
table.innerHTML="<tr>"+h.map(x=>"<th>"+x+"</th>").join("")+"</tr>";
data.forEach((r,i)=>{
let row="<tr>";
h.forEach(k=>{
if(k==="remark"){
row+=`<td><input value="${r[k]}" onchange="updateRemark(${i},this.value)"></td>`;
}else{
row+=`<td>${r[k]}</td>`;
}
});
row+="</tr>";
table.innerHTML+=row;
});
}

/* DOWNLOAD */
function downloadExcel(){
if(!currentData.length){alert("No data");return;}
let ws=XLSX.utils.json_to_sheet(currentData);
let wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Court Data");
XLSX.writeFile(wb,"Court_"+workDate.value+".xlsx");
}
</script>
</body>
</html>
