<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Court File Management</title>

<!-- ZXing Barcode -->
<script src="https://unpkg.com/@zxing/library@latest"></script>

<!-- Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root{
  --primary:#1f3c88;
  --success:#2e7d32;
  --danger:#c62828;
  --bg:#f2f4f7;
}
body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:var(--bg);
}
.header{
  background:var(--primary);
  color:#fff;
  padding:14px;
  text-align:center;
  font-size:18px;
  font-weight:600;
}
.section{
  background:#fff;
  margin:10px;
  padding:12px;
  border-radius:8px;
  box-shadow:0 1px 4px rgba(0,0,0,.08);
}
.section h3{
  margin:0 0 8px 0;
  font-size:15px;
}
input,button{
  width:100%;
  padding:10px;
  margin-top:6px;
  font-size:14px;
  border-radius:6px;
}
input{border:1px solid #ccc}
button{
  border:none;
  color:#fff;
  font-weight:600;
}
.btn-primary{background:var(--primary)}
.btn-success{background:var(--success)}
.btn-danger{background:var(--danger)}
.btn-gray{background:#555}
.actions{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}

/* TABLE */
.table-wrap{
  margin:10px;
  background:#fff;
  border-radius:8px;
  overflow:auto;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}
th{
  position:sticky;
  top:0;
  background:#e9ecf1;
  padding:6px;
  border-bottom:2px solid #bbb;
}
td{
  padding:6px;
  border-bottom:1px solid #ddd;
}
tr:nth-child(even){background:#fafafa}

/* SCANNER */
#scannerWrap{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  z-index:999;
}
#video{
  width:100%;
  height:80vh;
  object-fit:cover;
}
#scanLine{
  position:absolute;
  top:45%;
  left:10%;
  width:80%;
  height:3px;
  background:red;
}
#closeScan{
  background:var(--danger);
}

/* NEXT DATE POPUP */
#nextDatePopup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  z-index:1000;
}
#popupBox{
  background:#fff;
  margin:25% auto;
  padding:15px;
  width:90%;
  border-radius:8px;
}
</style>
</head>

<body>

<div class="header">Court File Management</div>

<div class="section">
  <h3>üìÖ Working Date</h3>
  <input type="date" id="workDate">
</div>

<div class="section">
  <h3>üìÇ Excel Upload</h3>
  <input type="file" id="excelFile">
  <button class="btn-primary" onclick="uploadExcel()">Upload Excel</button>
</div>

<div class="section">
  <h3>üîç Search</h3>
  <input type="text" id="searchBox" placeholder="Case / Party / SR No / PS">
</div>

<div class="section">
  <h3>üì∏ Scan Action</h3>
  <div class="actions">
    <button class="btn-success" onclick="scanSent()">Scan SENT</button>
    <button class="btn-primary" onclick="scanReceived()">Scan RECEIVED</button>
  </div>
</div>

<div class="section">
  <h3>‚¨áÔ∏è Export</h3>
  <button class="btn-primary" onclick="downloadExcel()">Download Excel</button>
</div>

<div class="table-wrap">
  <table id="table"></table>
</div>

<!-- SCANNER -->
<div id="scannerWrap">
  <div style="position:relative;">
    <video id="video"></video>
    <div id="scanLine"></div>
  </div>
  <button id="closeScan" onclick="stopScanner()">Close Scanner</button>
</div>

<!-- NEXT DATE POPUP -->
<div id="nextDatePopup">
  <div id="popupBox">
    <h3>Next Date Select</h3>
    <input type="date" id="nextDateInput">
    <button class="btn-primary" onclick="saveNextDate()">Save Next Date</button>
  </div>
</div>

<script>
let currentData=[], filteredData=[], scanMode="", codeReader, lastReceivedIndex=null;

workDate.onchange=()=>{
  let s=localStorage.getItem("court_"+workDate.value);
  currentData=s?JSON.parse(s):[];
  filteredData=[...currentData];
  drawTable(filteredData);
};

searchBox.oninput=()=>{
  let q=searchBox.value.toLowerCase();
  filteredData=q?currentData.filter(r=>Object.values(r).join(" ").toLowerCase().includes(q)):[...currentData];
  drawTable(filteredData);
};

function uploadExcel(){
  if(!workDate.value)return alert("Select date");
  let f=excelFile.files[0]; if(!f)return;
  let r=new FileReader();
  r.onload=e=>{
    let wb=XLSX.read(e.target.result,{type:"binary"});
    let rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1,defval:""});
    rows.shift();
    currentData=rows.map(r=>({
      srno:r[0]||"",
      caseno:String(r[1]||"").trim(),
      partyname:r[2]||"",
      section:r[3]||"",
      ps:r[4]||"",
      sent:"",
      received:"",
      receiveddate:"",
      nextdate:""
    }));
    localStorage.setItem("court_"+workDate.value,JSON.stringify(currentData));
    filteredData=[...currentData];
    drawTable(filteredData);
  };
  r.readAsBinaryString(f);
}

function downloadExcel(){
  let ws=XLSX.utils.json_to_sheet(currentData);
  let wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Court Data");
  XLSX.writeFile(wb,"Court_"+workDate.value+".xlsx");
}

/* SCAN */
function scanSent(){scanMode="SENT";startScanner()}
function scanReceived(){scanMode="RECEIVED";startScanner()}

async function startScanner(){
  if(!currentData.length)return alert("No data");
  scannerWrap.style.display="block";
  codeReader=new ZXing.BrowserMultiFormatReader(
    new Map([[ZXing.DecodeHintType.POSSIBLE_FORMATS,[ZXing.BarcodeFormat.CODE_128]]])
  );
  const d=await codeReader.listVideoInputDevices();
  const cam=d.find(x=>x.label.toLowerCase().includes("back"))||d[0];
  codeReader.decodeFromVideoDevice(cam.deviceId,"video",res=>{
    if(res)handleScan(res.text);
  });
}

function stopScanner(){
  if(codeReader){codeReader.reset();codeReader=null}
  scannerWrap.style.display="none";
}

function handleScan(code){
  stopScanner();
  let idx=currentData.findIndex(r=>r.caseno===code.trim());
  if(idx===-1)return alert("Mismatch ‚ùå");
  let row=currentData[idx];

  if(scanMode==="SENT"){
    if(row.sent)return alert("Already Sent");
    row.sent="YES";
    alert("Sent ‚úÖ");
  }
  if(scanMode==="RECEIVED"){
    if(!row.sent)return alert("Not Sent Yet");
    row.received="YES";
    row.receiveddate=new Date().toLocaleDateString();
    lastReceivedIndex=idx;
    alert("Received ‚úÖ");
    nextDatePopup.style.display="block";
  }
  localStorage.setItem("court_"+workDate.value,JSON.stringify(currentData));
  filteredData=[...currentData];
  drawTable(filteredData);
}

function saveNextDate(){
  let nd=nextDateInput.value;
  if(!nd)return alert("Select next date");
  currentData[lastReceivedIndex].nextdate=nd;
  localStorage.setItem("court_"+workDate.value,JSON.stringify(currentData));
  nextDatePopup.style.display="none";
  drawTable(filteredData);
}

function drawTable(data){
  table.innerHTML="";
  if(!data.length)return;
  let h=Object.keys(data[0]);
  table.innerHTML="<tr>"+h.map(x=>"<th>"+x+"</th>").join("")+"</tr>";
  data.forEach(r=>{
    table.innerHTML+="<tr>"+h.map(x=>"<td>"+(r[x]||"")+"</td>").join("")+"</tr>";
  });
}
</script>

</body>
</html>
