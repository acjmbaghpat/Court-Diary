<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Court File App – QR Version</title>

<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;background:#f4f4f4;margin:0;padding:10px}
.section{background:#fff;padding:10px;margin-bottom:12px;border-radius:6px}
h3{margin:0 0 6px 0}
input,button{width:100%;padding:12px;margin:6px 0;font-size:15px}
button{background:#1976d2;color:#fff;border:none;border-radius:4px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #333;padding:5px;font-size:12px}

/* SCANNER */
#scannerWrap{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  z-index:999
}
#video{
  width:100vw;
  height:80vh;
  object-fit:cover
}
#scanBox{
  position:absolute;
  top:30%;
  left:20%;
  width:60%;
  height:40%;
  border:4px solid #00ff00;
  box-sizing:border-box;
}

/* NEXT DATE POPUP */
#nextDatePopup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  display:none;
  z-index:1000
}
#popupBox{
  background:#fff;
  margin:20% auto;
  padding:15px;
  width:90%;
  border-radius:6px
}
</style>
</head>

<body>

<div class="section">
  <h3>Working Date</h3>
  <input type="date" id="workDate">
</div>

<div class="section">
  <h3>Excel Upload</h3>
  <input type="file" id="excelFile">
  <button onclick="uploadExcel()">Upload Excel</button>
</div>

<div class="section">
  <h3>Search</h3>
  <input type="text" id="searchBox">
</div>

<div class="section">
  <h3>Scan Action</h3>
  <button onclick="scanSent()">Scan SENT (QR)</button>
  <button onclick="scanReceived()">Scan RECEIVED (QR)</button>
</div>

<div class="section">
  <button onclick="downloadExcel()">Download Excel</button>
</div>

<table id="table"></table>

<!-- SCANNER -->
<div id="scannerWrap">
  <div style="position:relative;">
    <video id="video"></video>
    <div id="scanBox"></div>
  </div>
  <button onclick="stopScanner()">Close Scanner</button>
</div>

<!-- NEXT DATE POPUP -->
<div id="nextDatePopup">
  <div id="popupBox">
    <h3>Next Date</h3>
    <input type="date" id="nextDateInput">
    <button onclick="saveNextDate()">Save</button>
  </div>
</div>

<script>
let currentData=[];
let filteredData=[];
let scanMode="";
let codeReader;
let lastReceivedIndex=null;

workDate.addEventListener("change",()=>{
  let saved=localStorage.getItem("court_"+workDate.value);
  currentData=saved?JSON.parse(saved):[];
  filteredData=[...currentData];
  drawTable(filteredData);
});

searchBox.addEventListener("input",()=>{
  let q=searchBox.value.toLowerCase();
  filteredData=q?currentData.filter(r=>Object.values(r).join(" ").toLowerCase().includes(q)):[...currentData];
  drawTable(filteredData);
});

function uploadExcel(){
  if(!workDate.value){alert("Select date first");return;}
  let file=excelFile.files[0];
  if(!file){alert("Select Excel file");return;}

  let reader=new FileReader();
  reader.onload=e=>{
    let wb=XLSX.read(e.target.result,{type:"binary"});
    let rows=XLSX.utils.sheet_to_json(
      wb.Sheets[wb.SheetNames[0]],
      {header:1,defval:""}
    );
    rows.shift();

    currentData=rows.map(r=>({
      srno:r[0]||"",
      caseno:String(r[1]||"").trim(),
      partyname:r[2]||"",
      section:r[3]||"",
      ps:r[4]||"",
      sent:"",
      received:"",
      receiveddate:"",
      nextdate:""
    }));

    localStorage.setItem("court_"+workDate.value,JSON.stringify(currentData));
    filteredData=[...currentData];
    alert("Excel Uploaded");
    drawTable(filteredData);
  };
  reader.readAsBinaryString(file);
}

function downloadExcel(){
  if(!currentData.length){alert("No data");return;}
  let ws=XLSX.utils.json_to_sheet(currentData);
  let wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Court Data");
  XLSX.writeFile(wb,"Court_"+workDate.value+".xlsx");
}

/* QR SCANNER */
function scanSent(){scanMode="SENT";startScanner();}
function scanReceived(){scanMode="RECEIVED";startScanner();}

async function startScanner(){
  if(!currentData.length){alert("No data");return;}

  scannerWrap.style.display="block";

  codeReader=new ZXing.BrowserQRCodeReader();

  try{
    const devices=await codeReader.listVideoInputDevices();
    const cam=devices.find(d=>d.label.toLowerCase().includes("back"))||devices[0];

    codeReader.decodeFromVideoDevice(cam.deviceId,"video",(result,err)=>{
      if(result){
        handleScan(result.text);
      }
    });

  }catch(e){
    alert("Camera error");
  }
}

function stopScanner(){
  if(codeReader){codeReader.reset();}
  scannerWrap.style.display="none";
}

function handleScan(code){
  stopScanner();
  code=code.trim();

  let idx=currentData.findIndex(r=>r.caseno===code);
  if(idx===-1){alert("Mismatch ❌");return;}

  let row=currentData[idx];

  if(scanMode==="SENT"){
    if(row.sent){alert("Already Sent");return;}
    row.sent="YES";
    alert("Sent ✅");
  }

  if(scanMode==="RECEIVED"){
    if(!row.sent){alert("Not Sent Yet");return;}
    row.received="YES";
    row.receiveddate=new Date().toLocaleDateString();
    lastReceivedIndex=idx;
    alert("Received ✅");
    nextDatePopup.style.display="block";
  }

  localStorage.setItem("court_"+workDate.value,JSON.stringify(currentData));
  filteredData=[...currentData];
  drawTable(filteredData);
}

function saveNextDate(){
  if(!nextDateInput.value){alert("Select next date");return;}
  currentData[lastReceivedIndex].nextdate=nextDateInput.value;
  localStorage.setItem("court_"+workDate.value,JSON.stringify(currentData));
  nextDatePopup.style.display="none";
  drawTable(filteredData);
}

function drawTable(data){
  table.innerHTML="";
  if(!data.length)return;
  let h=Object.keys(data[0]);
  table.innerHTML="<tr>"+h.map(x=>"<th>"+x+"</th>").join("")+"</tr>";
  data.forEach(r=>{
    table.innerHTML+="<tr>"+h.map(x=>"<td>"+(r[x]||"")+"</td>").join("")+"</tr>";
  });
}
</script>

</body>
</html>
